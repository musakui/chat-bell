const e=/(?:@(?<tags>\S+) )?:(?<pref>\S+) (?<cmd>\S+)(?: (?<args>.+))?\r/,t=({user:e,text:t,tags:n})=>{const s=document.createElement("li");var o,a;return s.innerHTML=`${o=e,a=n["display-name"],`<a href="https://twitch.tv/${o}">${a}</a>`}: <span>${t}</span>`,s},n=async n=>{var s;if(!n.channel)return;const o=new Audio(n.url||"/chat-bell/chirin.mp3");n.volume&&(o.volume=parseFloat(n.volume));const a=document.createElement(n.el||"ul"),l=n.channel.toLowerCase(),r=new Set([l]),c=null==(s=n.ignore)?void 0:s.toLowerCase();c&&console.log("ignore:",c.split(/[, ]/).map((e=>(r.add(e),e))));const i=1e3*(n.glows||15);let d=null;const u=document.querySelector("a");u.onclick=()=>{u.style.display="none",d()},u.style.display="block",await new Promise((e=>{d=e}));const{messages:p}=await(async t=>{let n=null,s=null;const o=[],a=`justinfan${Math.floor(1e5*Math.random())}`,l=await new Promise(((e,n)=>{const s=new WebSocket("wss://irc-ws.chat.twitch.tv:443");s.onerror=e=>n(e),s.onopen=()=>{["CAP REQ :twitch.tv/tags",`NICK ${a}`,`JOIN #${t}`].map((e=>s.send(e))),e(s)}}));return l.addEventListener("message",(t=>{t.data.split("\n").forEach((t=>{var s;if(!t)return;if("PING"===t.slice(0,4))return l.send(t.replace("I","O"));const{tags:a,pref:r,cmd:c,args:i}=(null==(s=t.match(e))?void 0:s.groups)||{};"PRIVMSG"===c&&(o.push({user:r.split("!")[0],text:i.split(" :",2)[1],tags:Object.fromEntries((null==a?void 0:a.split(";").map((e=>e.split("="))))||[])}),n&&(n(),n=null))}))})),l.addEventListener("close",(()=>{s=!1})),s=!0,{messages:async function*(){for(;s;){for(;o.length;)yield o.shift();await new Promise((e=>{n=e}))}}}})(l),m=document.createElement("div");m.innerHTML=`connected to ${l} <a href="?">reset</a>`,document.body.append(m,a);for await(const e of p()){if(r.has(e.user))continue;r.add(e.user),o.play(),console.log("NEW",[e.user,e.text]);const n=t(e);a.appendChild(n),setTimeout((()=>n.classList.add("done")),i),setTimeout((()=>{a.scrollTop=a.scrollHeight}),100)}};export{n as init};
