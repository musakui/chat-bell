const e=/(?:@(?<tags>\S+) )?:(?<pref>\S+) (?<cmd>\S+)(?: (?<args>.+))?\r/,t=({user:e,text:t,tags:n})=>{const s=document.createElement("li");var a,o;return s.innerHTML=`${a=e,o=n["display-name"],`<a href="https://twitch.tv/${a}">${o}</a>`}: <span>${t}</span>`,s},n=async n=>{var s;if(!n.channel)return;const a=new Audio(n.url||"/chirin.mp3");n.volume&&(a.volume=parseFloat(n.volume));const o=document.createElement(n.el||"ul"),r=n.channel.toLowerCase(),l=new Set([r]),c=null==(s=n.ignore)?void 0:s.toLowerCase();c&&console.log("ignore:",c.split(/[, ]/).map((e=>(l.add(e),e))));let i=null;const u=document.querySelector("a");u.onclick=()=>{u.style.display="none",i()},u.style.display="block",await new Promise((e=>{i=e}));const{messages:d}=await(async t=>{let n=null,s=null;const a=[],o=`justinfan${Math.floor(1e5*Math.random())}`,r=await new Promise(((e,n)=>{const s=new WebSocket("wss://irc-ws.chat.twitch.tv:443");s.onerror=e=>n(e),s.onopen=()=>{["CAP REQ :twitch.tv/tags",`NICK ${o}`,`JOIN #${t}`].map((e=>s.send(e))),e(s)}}));return r.addEventListener("message",(t=>{t.data.split("\n").forEach((t=>{var s;if(!t)return;if("PING"===t.slice(0,4))return r.send(t.replace("I","O"));const{tags:o,pref:l,cmd:c,args:i}=(null==(s=t.match(e))?void 0:s.groups)||{};"PRIVMSG"===c&&(a.push({user:l.split("!")[0],text:i.split(" :",2)[1],tags:Object.fromEntries((null==o?void 0:o.split(";").map((e=>e.split("="))))||[])}),n&&(n(),n=null))}))})),r.addEventListener("close",(()=>{s=!1})),s=!0,{messages:async function*(){for(;s;){for(;a.length;)yield a.shift();await new Promise((e=>{n=e}))}}}})(r),p=document.createElement("div");p.innerHTML=`connected to ${r} <a href="?">reset</a>`,document.body.append(p,o);for await(const e of d())l.has(e.user)||(l.add(e.user),a.play(),console.log("NEW",[e.user,e.text]),o.appendChild(t(e)),setTimeout((()=>{o.scrollTop=o.scrollHeight}),100))};export{n as init};
